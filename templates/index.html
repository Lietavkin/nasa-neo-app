<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NASA NEO Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <!-- About This Dashboard Collapsible Section -->
    <div class="about-collapsible">
        <input type="checkbox" id="about-toggle" checked hidden>
        <label for="about-toggle" class="about-header">
            <span>About This Dashboard</span>
            <span class="about-arrow">&#9660;</span>
        </label>
        <div class="about-content">
            <h2>Welcome to the NASA NEO Dashboard!</h2>
            <p>
                This dashboard visualizes and analyzes Near-Earth Object (asteroid) data from NASA.<br><br>
                <strong>Features:</strong>
                <ul>
                    <li>View real-time asteroid data fetched from NASA's API</li>
                    <li>See risk scores and hazard predictions for each asteroid</li>
                    <li>Explore feature importances used by the machine learning model</li>
                    <li>Download a PDF report of your predictions</li>
                    <li>Retrain the model with the latest data</li>
                </ul>
                <strong>How to use:</strong>
                <ul>
                    <li>Browse the dashboard for up-to-date asteroid information</li>
                    <li>Check the "Risk Score" column for color-coded risk levels</li>
                    <li>Click "Retrain Model" to update predictions with new data</li>
                    <li>Click "Download Report" to save a summary of your results</li>
                </ul>
                <em>All data and predictions are for educational and demonstration purposes only.</em>
            </p>
        </div>
    </div>
    <!-- End About Section -->
    <!-- EDA Collapsible Section -->
    <div class="eda-collapsible">
        <input type="checkbox" id="eda-toggle" checked hidden>
        <label for="eda-toggle" class="eda-header">
            <span>Exploratory Data Analysis (EDA)</span>
            <span class="eda-arrow">&#9660;</span>
        </label>
        <div class="eda-content">
            <p style="font-size:1.2em; color:#eaf6ff; margin-bottom:2em;">
                This section gives a quick summary of the dataset used to train the model, including distributions and trends. EDA helps us understand the data, spot patterns, and identify relationships between features and the target variable.
            </p>
            <div class="eda-chart-block">
                <div class="eda-chart-title">Hazardous vs Non-Hazardous Asteroids</div>
                <img src="{{ url_for('static', filename='eda_target_hist.png') }}" alt="Hazardous vs Non-Hazardous Histogram" class="eda-img">
            </div>
            <div class="eda-chart-block">
                <div class="eda-chart-title">Distribution of Asteroid Diameters</div>
                <img src="{{ url_for('static', filename='eda_diameter_hist.png') }}" alt="Diameter Distribution Histogram" class="eda-img">
            </div>
            <div class="eda-chart-block">
                <div class="eda-chart-title">Correlation Heatmap of Features</div>
                <img src="{{ url_for('static', filename='eda_corr_heatmap.png') }}" alt="Correlation Heatmap" class="eda-img">
            </div>
        </div>
    </div>
    <!-- End EDA Section -->
    <!-- PCA Projection Section -->
    <div class="pca-section">
        <h2 class="chart-title">PCA Projection: Before & After</h2>
        <div class="pca-img-block">
            <img src="{{ url_for('static', filename='pca_projection.png') }}" alt="PCA Projection Before and After" class="pca-img">
        </div>
        <div class="pca-desc">
            PCA reduces dimensionality to reveal structure in the data. This helps us see how separable the hazardous and non-hazardous objects are based on the top principal components.
        </div>
    </div>
    <!-- End PCA Section -->
    <div class="container">
        <h2>Predict Asteroid Hazard</h2>
        <form method="POST" action="/predict">
            <div style="margin-bottom:1.2em;">
                <label for="model_choice" style="font-weight:bold; color:#7ecbff; font-size:1.1em;">Choose Prediction Model:</label>
                <select name="model_choice" id="model_choice" style="margin-left:1em; padding:0.4em 1.2em; border-radius:8px; background:#101c2b; color:#0ff1ff; border:1.5px solid #223a5e; font-size:1.1em;">
                    <option value="Random Forest" {% if selected_model == 'Random Forest' %}selected{% endif %}>Random Forest</option>
                    <option value="Decision Tree" {% if selected_model == 'Decision Tree' %}selected{% endif %}>Decision Tree</option>
                    <option value="Logistic Regression" {% if selected_model == 'Logistic Regression' %}selected{% endif %}>Logistic Regression</option>
                </select>
            </div>
            <div>
                <label>Diameter (m):</label>
                <input type="number" step="any" name="diameter" required>
            </div>
            <div>
                <label>Velocity (km/h):</label>
                <input type="number" step="any" name="velocity" required>
            </div>
            <div>
                <label>Distance (km):</label>
                <input type="number" step="any" name="distance" required>
            </div>
            <button type="submit">Predict</button>
        </form>

        {% if prediction is not none %}
        <div class="alert alert-{{ 'danger' if prediction == 'Yes' else 'success' }}">
            <strong>Prediction:</strong> {{ 'üö® Potentially Hazardous!' if prediction == 'Yes' else '‚úÖ Safe' }}
            {% if confidence is not none %}
                <span style="margin-left: 1em;">Confidence: {{ (confidence * 100) | round(1) }}%</span>
            {% endif %}
        </div>
        <form method="GET" action="/download_report" style="margin-bottom: 1.5em;">
            <button type="submit" style="background:#059669; margin-top:0.5em;">‚¨áÔ∏è Download Report</button>
        </form>
        {% endif %}

        <h2 class="chart-title">Near-Earth Asteroids Detected This Week</h2>
        <div class="chart-section">
            <canvas id="sizeChart"></canvas>
        </div>

        <h3 class="chart-title">Diameter vs Approach Distance</h3>
        <div class="chart-section">
            <canvas id="scatterChart"></canvas>
        </div>

        <!-- Model Evaluation: Confusion Matrix and Metrics (Toggleable) -->
        <div class="container mt-4">
            <div class="model-dropdown-row">
                <label for="modelSelect" class="form-label text-light model-dropdown-label">Select Model:</label>
                <select class="form-select model-dropdown-large" id="modelSelect">
                    <option value="rf">Random Forest</option>
                    <option value="dt">Decision Tree</option>
                    <option value="lr">Logistic Regression</option>
                </select>
                <button id="toggleComparisonBtn" class="btn model-compare-toggle">Compare All Models Side-by-Side</button>
            </div>
        </div>

        <!-- Single Model Evaluation Section -->
        <div id="singleModelSection">
            <div id="rf" class="model-section model-eval-block">
                {{ rf_confusion_html | safe }}
                {{ rf_metrics_html | safe }}
                <!-- Feature importance chart for RF here -->
            </div>
            <div id="dt" class="model-section model-eval-block" style="display:none;">
                {{ dt_confusion_html | safe }}
                {{ dt_metrics_html | safe }}
                <!-- Feature importance chart for DT here -->
            </div>
            <div id="lr" class="model-section model-eval-block" style="display:none;">
                {{ lr_confusion_html | safe }}
                {{ lr_metrics_html | safe }}
                <!-- Feature importance chart for LR here -->
            </div>
        </div>

        <!-- Model Comparison Section (hidden by default) -->
        <div class="model-comparison-section" id="modelComparisonSection" style="display:none;">
            <h2 class="model-comparison-title">Compare All Models Side-by-Side</h2>
            <div class="model-comparison-matrices-row">
                <div class="model-comparison-matrix-card">
                    {{ rf_confusion_html | safe }}
                </div>
                <div class="model-comparison-matrix-card">
                    {{ dt_confusion_html | safe }}
                </div>
                <div class="model-comparison-matrix-card">
                    {{ lr_confusion_html | safe }}
                </div>
            </div>
            <div class="model-comparison-table-block">
                <table class="model-comparison-table">
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Accuracy</th>
                            <th>Precision</th>
                            <th>Recall</th>
                            <th>F1 Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Random Forest</td>
                            <td>{{ model_metrics['Random Forest']['accuracy'] | round(2) }}</td>
                            <td>{{ model_metrics['Random Forest']['precision'] | round(2) }}</td>
                            <td>{{ model_metrics['Random Forest']['recall'] | round(2) }}</td>
                            <td>{{ model_metrics['Random Forest']['f1'] | round(2) }}</td>
                        </tr>
                        <tr>
                            <td>Decision Tree</td>
                            <td>{{ model_metrics['Decision Tree']['accuracy'] | round(2) }}</td>
                            <td>{{ model_metrics['Decision Tree']['precision'] | round(2) }}</td>
                            <td>{{ model_metrics['Decision Tree']['recall'] | round(2) }}</td>
                            <td>{{ model_metrics['Decision Tree']['f1'] | round(2) }}</td>
                        </tr>
                        <tr>
                            <td>Logistic Regression</td>
                            <td>{{ model_metrics['Logistic Regression']['accuracy'] | round(2) }}</td>
                            <td>{{ model_metrics['Logistic Regression']['precision'] | round(2) }}</td>
                            <td>{{ model_metrics['Logistic Regression']['recall'] | round(2) }}</td>
                            <td>{{ model_metrics['Logistic Regression']['f1'] | round(2) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="model-comparison-desc">
                While Random Forest is the most accurate in our dataset, Decision Tree and Logistic Regression offer different trade-offs in terms of interpretability and generalization.
            </div>
            <div class="model-comparison-btn-row">
                <button id="hideComparisonBtn" class="btn model-comparison-hide-btn">Hide Comparison</button>
            </div>
        </div>

        <h2 class="chart-title">Feature Importance</h2>
        <div class="chart-section">
            <img src="{{ url_for('static', filename='feature_importance.png') }}" alt="Feature Importance Chart">
            <div class="feature-importance-desc">
                This chart shows all features considered by the model. The top 3 features were selected because they contribute the most to prediction accuracy, as shown by their higher importance scores.
            </div>
        </div>

        {% if importances %}
        <div class="feature-importance-list">
            <div class="feature-importance-title">Feature Importances</div>
            <div class="feature-importance-items">
                {% for feature, value in importances.items() %}
                    <div class="feature-importance-item">
                        <span class="feature-name">{{ feature|capitalize }}</span>
                        <span class="feature-value">{{ '%.3f'|format(value) }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Date</th>
                    <th>Diameter (min - max meters)</th>
                    <th>Hazardous?</th>
                </tr>
            </thead>
            <tbody>
                {% for date, asteroids in data.near_earth_objects.items() %}
                    {% for asteroid in asteroids %}
                        {% set distance = asteroid.close_approach_data[0].miss_distance.kilometers | float %}
                        {% set diameter = asteroid.estimated_diameter.meters.estimated_diameter_max | float %}
                        {% if asteroid.is_potentially_hazardous_asteroid %}
                            {# Risk formula: closer and larger = higher risk, capped at 99% #}
                            {% set base_risk = (diameter * 1000000 / distance) * 2 %}
                            {% set risk_percent = base_risk | round(0, 'floor') %}
                            {% if risk_percent > 99 %}{% set risk_percent = 99 %}{% endif %}
                            {% if risk_percent < 10 %}{% set risk_percent = 10 %}{% endif %}
                            {% set risk = 'üî¥ High Risk (' ~ risk_percent ~ '%)' %}
                        {% else %}
                            {# Non-hazardous: much lower risk, capped at 10% #}
                            {% set base_risk = (diameter * 100000 / distance) %}
                            {% set risk_percent = base_risk | round(0, 'floor') %}
                            {% if risk_percent > 10 %}{% set risk_percent = 10 %}{% endif %}
                            {% if risk_percent < 1 %}{% set risk_percent = 1 %}{% endif %}
                            {% set risk = 'üü¢ Low Risk (' ~ risk_percent ~ '%)' %}
                        {% endif %}
                        <tr>
                            <td>{{ asteroid.name }}</td>
                            <td>{{ date }}</td>
                            <td>{{ asteroid.estimated_diameter.meters.estimated_diameter_min | round(1) }} - {{ asteroid.estimated_diameter.meters.estimated_diameter_max | round(1) }}</td>
                            <td style="font-weight: 600; color:
                                {% if risk.startswith('üî¥') %}red
                                {% elif risk.startswith('üü†') %}orange
                                {% else %}green{% endif %};">
                                {{ risk }}
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Model Controls Section -->
    <div class="model-controls-section">
        <h2>Model Controls</h2>
        <form method="POST" action="/retrain">
            <button type="submit">üîÅ Retrain Model</button>
        </form>
        <div class="model-controls-label">Fetches latest NEO data and retrains the model</div>
    </div>

    <script>
        const ctx = document.getElementById('sizeChart').getContext('2d');
        const asteroidData = {
            labels: [
                {% for date, asteroids in data.near_earth_objects.items() %}
                    {% for asteroid in asteroids %}
                        '{{ asteroid.name }}',
                    {% endfor %}
                {% endfor %}
            ],
            datasets: [{
                label: 'Max Estimated Diameter (meters)',
                data: [
                    {% for date, asteroids in data.near_earth_objects.items() %}
                        {% for asteroid in asteroids %}
                            {{ asteroid.estimated_diameter.meters.estimated_diameter_max | round(1) }},
                        {% endfor %}
                    {% endfor %}
                ],
                backgroundColor: 'rgba(100, 149, 237, 0.6)'
            }]
        };

        new Chart(ctx, {
            type: 'bar',
            data: asteroidData,
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true },
                    title: { display: true, text: 'Diameter (m)' }
                }
            }
        });

        // Scatter plot: Diameter vs Distance
        const scatterCtx = document.getElementById('scatterChart').getContext('2d');
        const scatterData = {
            datasets: [{
                label: 'Diameter vs Approach Distance',
                data: [
                    {% for date, asteroids in data.near_earth_objects.items() %}
                        {% for asteroid in asteroids %}
                            {
                                x: {{ asteroid.estimated_diameter.meters.estimated_diameter_max | round(2) }},
                                y: {{ asteroid.close_approach_data[0].miss_distance.kilometers | float | round(2) }}
                            },
                        {% endfor %}
                    {% endfor %}
                ],
                backgroundColor: 'rgba(255, 99, 132, 0.7)'
            }]
        };
        new Chart(scatterCtx, {
            type: 'scatter',
            data: scatterData,
            options: {
                responsive: true,
                
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Diameter vs Approach Distance (km)' }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Diameter (meters)' }
                    },
                    y: {
                        title: { display: true, text: 'Approach Distance (km)' }
                    }
                }
            }
        });

        // Toggle between single model and comparison view
        const modelSelect = document.getElementById("modelSelect");
        const singleModelSection = document.getElementById("singleModelSection");
        const modelComparisonSection = document.getElementById("modelComparisonSection");
        const toggleComparisonBtn = document.getElementById("toggleComparisonBtn");
        const hideComparisonBtn = document.getElementById("hideComparisonBtn");
        const modelBlocks = {
            rf: document.getElementById("rf"),
            dt: document.getElementById("dt"),
            lr: document.getElementById("lr")
        };

        function showSingleModel(model) {
            for (const key in modelBlocks) {
                modelBlocks[key].style.display = key === model ? "block" : "none";
            }
            singleModelSection.style.display = "block";
            modelComparisonSection.style.display = "none";
        }

        modelSelect.addEventListener("change", function () {
            showSingleModel(this.value);
        });

        toggleComparisonBtn.addEventListener("click", function () {
            singleModelSection.style.display = "none";
            modelComparisonSection.style.display = "block";
        });

        hideComparisonBtn.addEventListener("click", function () {
            modelComparisonSection.style.display = "none";
            showSingleModel(modelSelect.value);
        });

        // On page load, show the default model (rf)
        showSingleModel(modelSelect.value);
    </script>
</body>
</html>

